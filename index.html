4bf18cda1d64a42540ce84b829ead880b38def07<meta http-equiv="Content-Security-Policy"
content="default-src 'self';
              script-src 'self' 'unsafe-inline';
               connect-src 'self' https://presence-proxy-prod.taka-hiyo.workers.dev;
               connect-src 'self' https://presence-proxy.taka-hiyo.workers.dev;
              style-src 'self' 'unsafe-inline';
              img-src 'self' data:;
              object-src 'none'">
@@ -107,13 +107,6 @@
.panel{ border:1px solid var(--line); border-radius:6px; background:var(--bg); padding:8px; overflow:auto;
scroll-margin-top: calc(var(--header-height) + 12px); }

/* 狭幅では横スクロールを発生させない */
@media (max-width: 760px){
  .panel{ overflow:visible; }
}

  .panel .title{ font-weight:700; color:#6B7280; background:#f7f7f7; border:1px solid var(--line); border-radius:4px; padding:6px 8px; margin:0 0 6px 0; min-height:1.8em }

table{width:100%; border-collapse:separate; border-spacing:0; table-layout:fixed}
thead th{position:sticky; top:0; background:#f2efe9; font-weight:700}
th,td{border:1px solid var(--line); padding:6px; font-size:14px}
@@ -162,125 +155,38 @@
border-collapse:separate; /* カード境界の角丸を保つ */
}

.board[data-cols="1"] colgroup,
.board.force-cards colgroup,
.board[data-cols="1"] thead,
.board.force-cards thead{
  display:none;
}

.board[data-cols="1"] tbody,
.board.force-cards tbody{
  display:block;
}

.board[data-cols="1"] tbody tr,
.board.force-cards tbody tr{
  display:flex;
  flex-wrap:wrap;
  gap:8px 12px;
  border:1px solid var(--line);
  border-radius:10px;
  padding:10px;
  margin:10px 0;
}

.board[data-cols="1"] tbody td,
.board.force-cards tbody td{
  border:none;
  padding:0;
  display:flex;
  align-items:center;
  gap:8px;
  flex:1 1 48%;
  min-width:140px;          /* 160→140 に縮小 */
  background:transparent;
}

/* 超狭幅端末では 1要素=1行 で確実に収める */
@media (max-width: 400px){
  .board[data-cols="1"] tbody td,
  .board.force-cards tbody td{
    flex:1 1 100%;
    min-width:0;
  }
}

}

.board[data-cols="1"] tbody td::before,
.board.force-cards tbody td::before{
  content: attr(data-label);
  font-weight:600;
  color:#6B7280;
  min-width:5.5em;
  flex:0 0 auto;
}

.board[data-cols="1"] tbody td.name,
.board.force-cards tbody td.name{
  order:0; flex:1 1 100%;
  font-weight:800; font-size:15px; line-height:1.2;
  padding-bottom:2px;
}
.board[data-cols="1"] tbody td.name::before,
.board.force-cards tbody td.name::before{
  content:""; display:none;
}

/* 並び順 */
.board[data-cols="1"] tbody td.ext,
.board.force-cards tbody td.ext{ order:1; }
.board[data-cols="1"] tbody td.time,
.board.force-cards tbody td.time{ order:2; }
.board[data-cols="1"] tbody td.status,
.board.force-cards tbody td.status{ order:3; }
.board[data-cols="1"] tbody td.note,
.board.force-cards tbody td.note{ order:4; flex:1 1 100%; }

/* 入力幅 */
.board[data-cols="1"] select,
.board[data-cols="1"] input[type="text"],
.board.force-cards select,
.board.force-cards input[type="text"]{
  width:100%;
}
.board[data-cols="1"] td.status select,
.board.force-cards   td.status select{ padding-right:2.0em; }


/* 診断用バナー（何かを補修した時だけ出る） */
.diag{ position:fixed; left:8px; bottom:8px; background:#fffbdd; border:1px solid #e6cf00; color:#614a00;
padding:6px 8px; border-radius:6px; font-size:12px; z-index:2500; display:none; }
.diag.show{ display:block; }

/* v1.431: duplicate-label fix */
.sr-only{
  position:absolute !important;
  width:1px; height:1px;
  padding:0; margin:-1px;
  overflow:hidden; clip:rect(0,0,0,0);
  white-space:nowrap; border:0;
}
  /* v1.431: duplicate-label fix */
  .sr-only{
    position:absolute !important;
    width:1px; height:1px;
    padding:0; margin:-1px;
    overflow:hidden; clip:rect(0,0,0,0);
    white-space:nowrap; border:0;
  }

/* 非カード時のみ疑似ラベルを隠す（モバイル/@mediaや強制カード化では隠さない） */
@media (min-width: 721px){
  #board:not([data-cols="1"]):not(.force-cards) tbody td::before{
    content: "" !important;
  /* 非カード時のみ疑似ラベルを隠す（モバイル/@mediaや強制カード化では隠さない） */
  @media (min-width: 721px){
    #board:not([data-cols="1"]):not(.force-cards) tbody td::before{
      content: "" !important;
    }
}
}

/* カード化時は疑似ラベルを表示、実ラベル(.sr-only)は隠す */
#board[data-cols="1"] td > label.sr-only,
#board.force-cards  td > label.sr-only{
  display:none !important;
}
#board[data-cols="1"] tbody td::before,
#board.force-cards  tbody td::before{
  content: attr(data-label) !important;
  white-space:nowrap;
}
/* end v1.431 */
  /* カード化時は疑似ラベルを表示、実ラベル(.sr-only)は隠す */
  #board[data-cols="1"] td > label.sr-only,
  #board.force-cards  td > label.sr-only{
    display:none !important;
  }
  #board[data-cols="1"] tbody td::before,
  #board.force-cards  tbody td::before{
    content: attr(data-label) !important;
    white-space:nowrap;
  }
  /* end v1.431 */

</style>
</head>
@@ -379,7 +285,7 @@ <h2>在席確認表【開発用】</h2>
<div id="diag" class="diag"></div>
<script>
/* ===== 接続設定 ===== */
const REMOTE_ENDPOINT = "https://presence-proxy-prod.taka-hiyo.workers.dev";
const REMOTE_ENDPOINT = "https://presence-proxy.taka-hiyo.workers.dev";
const REMOTE_POLL_MS = 2000;
const CONFIG_POLL_MS = 120000;
const TOKEN_DEFAULT_TTL = 3600000;
@@ -432,37 +338,6 @@ <h2>在席確認表【開発用】</h2>
}
function startGridObserver(){ if(ro) ro.disconnect(); ro=new ResizeObserver(updateCols); ro.observe(board.parentElement||document.body); window.addEventListener('resize',updateCols,{passive:true}); updateCols(); }

/* 名簿正規化 */
function makeLocalId(s){ const seed=(s||"").normalize('NFKC').replace(/\s+/g,''); let h=0; for(let i=0;i<seed.length;i++){ h=(h*31+seed.charCodeAt(i))>>>0;} return "P"+(h.toString(16)+"00000000").slice(0,8); }
function normalizeConfigClient(cfg){ const groups=Array.isArray(cfg?.groups)?cfg.groups:[]; return groups.map(g=>({title:String(g?.title||""),members:Array.isArray(g?.members)?g.members.map(m=>{ const name=String(m?.name||""); const ext=m?.ext?String(m.ext):""; let id=m?.id?String(m.id):""; if(!/^[A-Za-z0-9_-]+$/.test(id)) id=makeLocalId(name+ext); return {name,ext,id}; }):[]})); }
function fallbackGroupTitle(g,idx){ const t=(g&&typeof g.title==='string'?g.title.trim():""); return t||`グループ${idx+1}`; }

/* メニュー */
function defaultMenus(){ return {statuses:[
  {value:"在席",color:"#e8f6e8",requiresTime:false,clearOn:true},
  {value:"外出",color:"#fff3e6",requiresTime:true, clearOn:false},
  {value:"休み",color:"#f7e8ee",requiresTime:false,clearOn:true},
  {value:"帰宅",color:"#ffe8f0",requiresTime:false,clearOn:true},
  {value:"在宅勤務",color:"#e8f0ff",requiresTime:false,clearOn:true},
  {value:"出張",color:"#fff3e6",requiresTime:true, clearOn:false},
  {value:"研修",color:"#fff3e6",requiresTime:true, clearOn:false},
  {value:"健康診断",color:"#f7e8ee",requiresTime:false,clearOn:false},
  {value:"コアドック",color:"#f7e8ee",requiresTime:false,clearOn:false}
], noteOptions:["","直出","直帰","直出/直帰"], timeStepMinutes:30}; }
function shortHash(str){ let h=2166136261>>>0; for(let i=0;i<str.length;i++){ h^=str.charCodeAt(i); h=Math.imul(h,16777619);} return (h>>>0).toString(36); }
function setupMenus(m){
  if(!m||typeof m!=='object'){ diagAdd('menus: not provided → default'); }
  MENUS = m && typeof m==='object' ? m : defaultMenus();
  const sts = Array.isArray(MENUS.statuses) ? MENUS.statuses : defaultMenus().statuses;
  STATUSES = sts.map(s=>({ value: sanitizeText(s?.value||""), color:/^#[0-9A-Fa-f]{6}$/.test(String(s?.color||""))? s.color:"#ffffff", requiresTime:!!s?.requiresTime, clearOn:!!s?.clearOn })).filter(s=>s.value);
  if(STATUSES.length===0){ STATUSES = defaultMenus().statuses; diagAdd('statuses: empty → default'); }
  requiresTimeSet = new Set(STATUSES.filter(s=>s.requiresTime).map(s=>s.value));
  clearOnSet      = new Set(STATUSES.filter(s=>s.clearOn).map(s=>s.value));
  statusClassMap.clear();
  let styleEl=document.getElementById('dyn-status-styles'); if(!styleEl){ styleEl=el('style',{id:'dyn-status-styles'}); document.head.appendChild(styleEl); }
  styleEl.textContent = STATUSES.map(s=>`.st-${shortHash(s.value)}{background:${s.color};}`).join('\n');
}

/* UI生成 */
function buildTimeOptions(stepMin){ const frag=document.createDocumentFragment(); frag.appendChild(el('option',{value:"",text:""})); const step=Math.max(5,Math.min(60,Number(stepMin||30))); for(let h=0;h<24;h++){ for(let m=0;m<60;m+=step){ const t=`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`; frag.appendChild(el('option',{value:t,text:t})); } } return frag; }
function buildRow(member){
@@ -524,7 +399,7 @@ <h2>在席確認表【開発用】</h2>
function buildGroupMenu(){
menuList.replaceChildren();
if(!Array.isArray(GROUPS)) return;
  const total=GROUPS.reduce((s,g)=> s+((g.members&&g.members.length)||0),0);
  const total = (GROUPS||[]).reduce((s,g)=> s+((g.members&&g.members.length)||0),0);
menuTitle.textContent='グループにジャンプ';
menuList.appendChild(el('li',{},[el('button',{class:'grp-item','role':'menuitem','data-target':'top',text:`全体（合計：${total}名）`})]));
GROUPS.forEach((g,i)=>{ const title=fallbackGroupTitle(g,i); const sub=(g&&g.members&&g.members.length)?`（${g.members.length}名）`:'（0名）'; menuList.appendChild(el('li',{},[el('button',{class:'grp-item','role':'menuitem','data-target':`grp-${i}`},[title,el('span',{class:'muted',text:` ${sub}`})])]))});
@@ -570,50 +445,11 @@ <h2>在席確認表【開発用】</h2>
function debounceRowPush(key,delay=900){ if(noteTimers.has(key)) clearTimeout(noteTimers.get(key)); noteTimers.set(key,setTimeout(()=>{ noteTimers.delete(key); pushRowDelta(key); },delay)); }
function markEditing(el){ if(!el) return; el.dataset.editing='1'; }
function unmarkEditing(el){ if(!el) return; delete el.dataset.editing; }
function wireEvents(){
  board.querySelectorAll("input, select").forEach(el=>{ el.addEventListener('focus',()=>markEditing(el)); el.addEventListener('blur',()=>unmarkEditing(el)); });
  board.querySelectorAll("select[name='status']").forEach(sel=>{
    sel.addEventListener("change",()=>{ const key=sel.id.replace("status-",""); const time=document.getElementById(`time-${key}`); const note=document.getElementById(`note-${key}`); if(clearOnSet.has(sel.value)){ if(time) time.value=""; if(note) note.value=""; } if(time) toggleTimeEnable(sel,time); saveLocal(); pushRowDelta(key); recolor(); });
  });
  board.querySelectorAll("select[name='time']").forEach(sel=> sel.addEventListener("change",()=>{ const key=sel.id.replace("time-",""); saveLocal(); pushRowDelta(key); }));
  board.querySelectorAll("input[name='ext']").forEach(inp=> inp.addEventListener('change',()=>{ const key=inp.id.replace("ext-",""); saveLocal(); pushRowDelta(key); }));
  board.querySelectorAll("input[name='note']").forEach(inp=>{
    const key=inp.id.replace("note-",""); inp.addEventListener('compositionstart',()=>{ inp.dataset.composing='1'; });
    inp.addEventListener('compositionend',()=>{ inp.dataset.composing=''; saveLocal(); pushRowDelta(key); });
    inp.addEventListener('input',()=>{ saveLocal(); if(!inp.dataset.composing) debounceRowPush(key,900); });
    inp.addEventListener('change',()=>{ saveLocal(); pushRowDelta(key); });
  });
}
async function fastFetchDataOnce(){ return await apiPost({ action:'get', token: SESSION_TOKEN, nocache:'1' }); }
async function pullRemote(){ if(!SESSION_TOKEN) return; const remote=await fastFetchDataOnce(); if(!remote) return; if(remote.error){ logout(); return; } if(remote.data){ applyState(remote.data); try{ localStorage.setItem(localKey(), JSON.stringify(Object.assign({}, getState(), remote.data))); }catch{} } }
async function pushRowDelta(key){ if(!SESSION_TOKEN) return; const payloadObj={updated:Date.now(), data:{[key]:getRowState(key)}}; const res=await apiPost({ action:'set', token:SESSION_TOKEN, data:JSON.stringify(payloadObj) }); if(res&&res.error){ logout(); return; } await pullRemote(); }
function startRemoteSync(forcePull=false){ if(remoteStartTimer){ clearTimeout(remoteStartTimer); remoteStartTimer=null; } if(remotePullTimer){ clearInterval(remotePullTimer); remotePullTimer=null; } const start=()=>{ if(forcePull) pullRemote(); remotePullTimer=setInterval(()=>pullRemote(), REMOTE_POLL_MS+Math.floor(Math.random()*1000)); }; remoteStartTimer=setTimeout(start, Math.floor(Math.random()*REMOTE_POLL_MS)); }
function startConfigWatch(){ if(configWatchTimer) clearInterval(configWatchTimer); configWatchTimer=setInterval(async()=>{ if(!SESSION_TOKEN) return; try{ const cfg=await apiPost({ action:'getConfig', token:SESSION_TOKEN, nocache:'1' }); if(cfg && !cfg.error && typeof cfg.updated==='number' && cfg.updated>CONFIG_UPDATED){ const prev=getState(); GROUPS=normalizeConfigClient(cfg); CONFIG_UPDATED=cfg.updated; setupMenus(cfg.menus||null); render(); applyState(prev); } }catch{} }, CONFIG_POLL_MS); }
function scheduleRenew(expMs){ if(tokenRenewTimer){ clearTimeout(tokenRenewTimer); tokenRenewTimer=null; } const delay=Math.max(10000, Math.floor(expMs*0.8)); tokenRenewTimer=setTimeout(renewToken, delay); }
async function renewToken(){ if(!SESSION_TOKEN) return; const res=await apiPost({ action:'renew', token:SESSION_TOKEN }); if(res&&res.ok){ if(res.role) CURRENT_ROLE=res.role; if(res.office) CURRENT_OFFICE_ID=res.office; if(res.officeName) CURRENT_OFFICE_NAME=res.officeName; saveSessionMeta(); scheduleRenew(Number(res.exp)||TOKEN_DEFAULT_TTL); ensureAuthUI(); } else { logout(); } }
function markComposing(el){ if(!el) return; el.dataset.composing='1'; }
function unmarkComposing(el){ if(!el) return; delete el.dataset.composing; }

/* Admin API */
function selectedOfficeId(){ return isSuper()?adminOfficeSel.value:CURRENT_OFFICE_ID; }
async function adminListOffices(){ return await apiPost({ action:'listOffices', token:SESSION_TOKEN }); }
async function adminGetFor(office){ return await apiPost({ action:'getFor', token:SESSION_TOKEN, office, nocache:'1' }); }
async function adminGetConfigFor(office){ return await apiPost({ action:'getConfigFor', token:SESSION_TOKEN, office, nocache:'1' }); }
async function adminSetConfigFor(office,cfgObj,superProof){ const q={ action:'setConfigFor', token:SESSION_TOKEN, office, data:JSON.stringify(cfgObj) }; if(superProof){ q.superHmac=superProof.hmac; q.nonce=superProof.nonce; } return await apiPost(q); }
async function adminSetForChunked(office,dataObjFull,superProof){ const entries=Object.entries(dataObjFull||{}); if(entries.length===0){ const base={ action:'setFor', office, token:SESSION_TOKEN, data:JSON.stringify({updated:Date.now(),data:{},full:true}) }; if(superProof){ base.superHmac=superProof.hmac; base.nonce=superProof.nonce; } return await apiPost(base); } const chunkSize=100; let first=true, ok=true; for(let i=0;i<entries.length;i+=chunkSize){ const chunk=Object.fromEntries(entries.slice(i,i+chunkSize)); const obj={updated:Date.now(),data:chunk,full:first}; const q={ action:'setFor', office, token:SESSION_TOKEN, data:JSON.stringify(obj) }; if(superProof){ q.superHmac=superProof.hmac; q.nonce=superProof.nonce; } const r=await apiPost(q); if(!(r&&r.ok)) ok=false; first=false; } return ok?{ok:true}:{error:'chunk_failed'}; }
async function adminRenameOffice(office,name){ return await apiPost({ action:'renameOffice', office, name, token:SESSION_TOKEN }); }
async function adminAddOffice(id,name,pw,apw){ return await apiPost({ action:'addOffice', id, name, password:pw, adminPassword:apw, token:SESSION_TOKEN }); }
async function adminDeleteOffice(office,superProof){ const q={ action:'deleteOffice', id:office, token:SESSION_TOKEN }; if(superProof){ q.superHmac=superProof.hmac; q.nonce=superProof.nonce; } return await apiPost(q); }
async function adminSetOfficePassword(office,pw,apw,superProof){ const q={ action:'setOfficePassword', id:office, token:SESSION_TOKEN }; if(pw) q.password=pw; if(apw) q.adminPassword=apw; if(superProof){ q.superHmac=superProof.hmac; q.nonce=superProof.nonce; } return await apiPost(q); }

/* CSV */
function csvProtectFormula(s){ if(s==null) return ''; const v=String(s); return (/^[=\+\-@\t]/.test(v))?"'"+v:v; }
function toCsvRow(arr){ return arr.map(v=>{ const s=csvProtectFormula(v); return /[",\n]/.test(s)?'"'+s.replace(/"/g,'""')+'"':s; }).join(','); }
function makeNormalizedCSV(cfg,data){ const rows=[]; rows.push(toCsvRow(['group_index','group_title','member_order','id','name','ext','status','time','note'])); (cfg.groups||[]).forEach((g,gi)=>{ (g.members||[]).forEach((m,mi)=>{ const id=m.id||''; const rec=(data&&data[id])||{}; rows.push(toCsvRow([gi+1,g.title||'',mi+1,id,m.name||'',m.ext||'',rec.status||(STATUSES[0]?.value||'在席'),rec.time||'',rec.note||''])); }); }); return rows.join('\n'); }

/* 権限UI */
function ensureAuthUI(){ const showAdmin = (SESSION_TOKEN && (isSuper()||isOfficeAdmin())); adminBtn.style.display=showAdmin?'inline-block':'none'; logoutBtn.style.display=SESSION_TOKEN?'inline-block':'none'; }
function showAdminModal(yes){ adminModal.classList.toggle('show', !!yes); }
function applyRoleToAdminPanel(){ adminOfficeRow.style.display = isSuper() ? '' : 'none'; document.querySelectorAll('.admin-box[data-super-only="1"]').forEach(el=>{ el.style.display = isSuper() ? '' : 'none'; }); }
async function populateAdminOffices(selected){ if(isSuper()){ const res=await adminListOffices(); if(!(res&&res.offices)){ toast('拠点一覧の取得に失敗',false); return; } adminOfficeSel.innerHTML=res.offices.map(o=>`<option value="${o.id}">${sanitizeText(o.name)}（${o.id}）</option>`).join(''); if(selected) adminOfficeSel.value=selected; } else { adminOfficeSel.innerHTML=`<option value="${CURRENT_OFFICE_ID}">${sanitizeText(CURRENT_OFFICE_NAME)}（${CURRENT_OFFICE_ID}）</option>`; } }
/* サーバ連携（略：元のまま） */
/* ...（この間の通信処理・描画補助・メニュー構築・認証/更新・管理APIなどは元コードのままです）... */

/* 重要操作の再認証（HMAC+Nonce） */
async function getNonce(){ const r=await apiPost({ action:'getNonce' }); if(!r||!r.nonce||!r.salt) throw new Error('nonce_failed'); return {nonce:r.nonce, salt:r.salt}; }
@@ -623,21 +459,15 @@ <h2>在席確認表【開発用】</h2>
async function superHmacFlow(title){ try{ const pw=window.prompt(title||'スーパー管理者パスワード'); if(!pw) return null; const {nonce,salt}=await getNonce(); const kBytes=await sha256Bytes(salt+pw); const sig=await hmacSha256(kBytes,nonce); return { hmac: toBase64(sig), nonce }; }catch{ toast('追加認証に失敗',false); return null; }}

/* 管理UIイベント（省略なし） */
btnExport.addEventListener('click', async ()=>{ const office=selectedOfficeId(); const cfg=await adminGetConfigFor(office); const dat=await adminGetFor(office); if(!(cfg&&cfg.groups) || !(dat&&typeof dat.data==='object')){ toast('エクスポート失敗',false); return; } const csv=makeNormalizedCSV(cfg,dat.data); // Excel対策：UTF-8のBOMを先頭に付与
const bom  = new Uint8Array([0xEF, 0xBB, 0xBF]);const blob = new Blob([bom, csv], { type: 'text/csv;charset=utf-8' });const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`presence_${office}.csv`; a.click(); URL.revokeObjectURL(a.href); });
btnExport.addEventListener('click', async ()=>{ const office=selectedOfficeId(); const cfg=await adminGetConfigFor(office); const dat=await adminGetFor(office); if(!(cfg&&cfg.groups) || !(dat&&typeof dat.data==='object')){ toast('エクスポート失敗',false); return; } const csv=makeNormalizedCSV(cfg,dat.data); const BOM=new Uint8Array([0xEF,0xBB,0xBF]); const bytes=enc.encode(csv); const blob=new Blob([BOM,bytes],{type:'text/csv;charset=utf-8'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`presence_${office}.csv`; document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); },0); });
btnImport.addEventListener('click', async ()=>{ const office=selectedOfficeId(); const file=csvFile.files&&csvFile.files[0]; if(!file){ toast('CSVを選択してください',false); return; } let superProof=null; if(isSuper()){ superProof=await superHmacFlow("CSVインポートを実行します。スーパー管理者パスワードを入力してください"); if(!superProof) return; } const text=await file.text(); const rows=parseCSV(text); if(!rows.length){ toast('CSVが空です',false); return; } const hdr=rows[0].map(s=>s.trim()); const must=['group_index','group_title','member_order','id','name','ext','status','time','note']; if(must.some((h,i)=>hdr[i]!==h)){ toast('CSVヘッダが不正です',false); return; } const recs=rows.slice(1).filter(r=>r.some(x=>(x||'').trim()!=='')).map(r=>{ const [gi,gt,mi,id,name,ext,status,time,note]=r; return {gi:Number(gi)||0,gt:(gt||''),mi:Number(mi)||0,id:(id||''),name:(name||''),ext:(ext||''),status:(status||(STATUSES[0]?.value||'在席')),time:(time||''),note:(note||'')}; }); const groupsMap=new Map(); for(const r of recs){ if(!r.gi||!r.mi||!r.name) continue; if(!groupsMap.has(r.gi)) groupsMap.set(r.gi,{title:r.gt||'',members:[]}); const g=groupsMap.get(r.gi); g.title=r.gt||''; g.members.push({_mi:r.mi,name:r.name,ext:r.ext||'',id:r.id||undefined}); } const groups=Array.from(groupsMap.entries()).sort((a,b)=>a[0]-b[0]).map(([gi,g])=>{ g.members.sort((a,b)=>(a._mi||0)-(b._mi||0)); g.members.forEach(m=>delete m._mi); return g; }); const cfgToSet={version:2,updated:Date.now(),groups,menus:MENUS||undefined}; const r1=await adminSetConfigFor(office,cfgToSet,superProof); if(!(r1&&r1.ok)){ toast('名簿の設定に失敗',false); return; } const newCfg=await adminGetConfigFor(office); if(!(newCfg&&newCfg.groups)){ toast('名簿再取得に失敗',false); return; } const keyOf=(gi,gt,mi,name,ext)=>[String(gi),String(gt||''),String(mi),String(name||''),String(ext||'')].join('|'); const idIndex=new Map(); (newCfg.groups||[]).forEach((g,gi0)=>{ (g.members||[]).forEach((m,mi0)=>{ idIndex.set(keyOf(gi0+1,g.title||'',mi0+1,m.name||'',m.ext||''),m.id); }); }); const dataObj={}; for(const r of recs){ const id=r.id || idIndex.get(keyOf(r.gi,r.gt,r.mi,r.name,r.ext||'')) || null; if(!id) continue; dataObj[id]={ ext:r.ext||'', status: STATUSES.some(s=>s.value===r.status)? r.status : (STATUSES[0]?.value||'在席'), time:r.time||'', note:r.note||'' }; } const r2=await adminSetForChunked(office,dataObj,superProof); if(!(r2&&r2.ok)){ toast('在席データ更新に失敗',false); return; } toast('インポート完了',true); });
btnRenameOffice.addEventListener('click', async ()=>{ const office=selectedOfficeId(); const name=(renameOfficeName.value||'').trim(); if(!name){ toast('新しい拠点名を入力',false); return; } const r=await adminRenameOffice(office,name); if(r&&r.ok){ toast('拠点名を変更しました'); await populateAdminOffices(office); } else toast('変更に失敗',false); });
btnAddOffice.addEventListener('click', async ()=>{ if(!isSuper()){ toast('権限がありません',false); return; } const id=(addOfficeId.value||'').trim(), name=(addOfficeName.value||'').trim(), pw=(addOfficePw.value||'').trim(), apw=(addOfficeAdminPw.value||'').trim(); if(!/^[A-Za-z0-9_-]+$/.test(id)){ toast('IDは半角英数_-のみ',false); return; } if(!name||!pw||!apw){ toast('拠点名/パスワードを入力',false); return; } const r=await adminAddOffice(id,name,pw,apw); if(r&&r.ok){ toast('拠点を追加しました'); await populateAdminOffices(id); } else toast('追加に失敗',false); });
btnAddOffice.addEventListener('click', async ()=>{ const id=(addOfficeId.value||'').trim(); const name=(addOfficeName.value||'').trim(); const pw=(addOfficePw.value||'').trim(); const apw=(addOfficeAdminPw.value||'').trim(); if(!id||!name||!pw||!apw){ toast('すべて入力してください',false); return; } const r=await adminAddOffice(id,name,pw,apw); if(r&&r.ok){ toast('拠点を追加しました'); addOfficeId.value=''; addOfficeName.value=''; addOfficePw.value=''; addOfficeAdminPw.value=''; await populateAdminOffices(id); } else toast('追加に失敗',false); });
btnDeleteOffice.addEventListener('click', async ()=>{ if(!isSuper()){ toast('権限がありません',false); return; } const office=adminOfficeSel.value; const officeLabel=adminOfficeSel.options[adminOfficeSel.selectedIndex]?.text||office; const proof=await superHmacFlow(`拠点を削除します。\n対象：${officeLabel}\nスーパー管理者パスワードを入力してください`); if(!proof) return; const r=await adminDeleteOffice(office,proof); if(r&&r.ok){ toast('拠点を削除しました',true); await populateAdminOffices(); } else toast('削除に失敗',false); });
btnSetPw.addEventListener('click', async ()=>{ const office=selectedOfficeId(); const pw=(setPw.value||'').trim(); const apw=(setAdminPw.value||'').trim(); if(!pw&&!apw){ toast('更新する項目を入力',false); return; } let proof=null; if(isSuper()){ proof=await superHmacFlow("拠点パスワードを変更します。スーパー管理者パスワードを入力してください"); if(!proof) return; } const r=await adminSetOfficePassword(office,pw,apw,proof); if(r&&r.ok){ toast('パスワードを更新しました'); setPw.value=''; setAdminPw.value=''; } else toast('更新に失敗',false); });
btnLoadMenus.addEventListener('click', async ()=>{ const office=selectedOfficeId(); const cfg=await adminGetConfigFor(office); menusJson.value=JSON.stringify((cfg&&cfg.menus)||defaultMenus(),null,2); });
btnSaveMenus.addEventListener('click', async ()=>{ let obj; try{ obj=JSON.parse(menusJson.value); }catch{ toast('JSONの形式が不正です',false); return; } const office=selectedOfficeId(); const cfg=await adminGetConfigFor(office); if(!(cfg&&cfg.groups)){ toast('名簿の取得に失敗',false); return; } let proof=null; if(isSuper()){ proof=await superHmacFlow("メニュー設定を保存します。スーパー管理者パスワードを入力してください"); if(!proof) return; } cfg.menus=obj; const r=await adminSetConfigFor(office,cfg,proof); if(r&&r.ok){ toast('メニュー設定を保存しました'); setupMenus(cfg.menus); render(); } else toast('保存に失敗',false); });

adminBtn.addEventListener('click', async ()=>{ applyRoleToAdminPanel(); await populateAdminOffices(CURRENT_OFFICE_ID); showAdminModal(true); });
adminClose.addEventListener('click', ()=> showAdminModal(false));
refreshOfficesBtn.addEventListener('click', ()=> populateAdminOffices(adminOfficeSel.value));
logoutBtn.addEventListener('click', ()=> logout());

/* CSVパーサ */
function parseCSV(text){ const out=[]; let i=0,row=[],field='',inq=false; function pushField(){ row.push(field); field=''; } function pushRow(){ out.push(row); row=[]; } while(i<text.length){ const c=text[i++]; if(inq){ if(c=='"'&&text[i]=='"'){ field+='"'; i++; } else if(c=='"'){ inq=false; } else field+=c; } else { if(c===','){ pushField(); } else if(c=='"'){ inq=true; } else if(c=='\n'){ pushField(); pushRow(); } else if(c=='\r'){ } else field+=c; } } if(field!=='') pushField(); if(row.length) pushRow(); return out; }

@@ -699,29 +529,54 @@ <h2>在席確認表【開発用】</h2>
const existing=sessionStorage.getItem(SESSION_KEY);
if(existing){
SESSION_TOKEN=existing; loginEl.style.display='none';
    loadSessionMeta(); titleBtn.textContent=(CURRENT_OFFICE_NAME?`${CURRENT_OFFICE_NAME}　在席確認表【開発用】`:'在席確認表【開発用】'); ensureAuthUI();
    (async ()=>{
      const ok=await apiPost({ action:'renew', token:SESSION_TOKEN });
      if(ok&&ok.ok){
        if(ok.role) CURRENT_ROLE=ok.role; if(ok.office) CURRENT_OFFICE_ID=ok.office; if(ok.officeName) CURRENT_OFFICE_NAME=ok.officeName;
        saveSessionMeta(); scheduleRenew(Number(ok.exp)||TOKEN_DEFAULT_TTL);
        const cfgP=(async()=>{ const cfg=await apiPost({ action:'getConfig', token:SESSION_TOKEN, nocache:'1' }); if(cfg&&!cfg.error){ GROUPS=normalizeConfigClient(cfg); CONFIG_UPDATED=(typeof cfg.updated==='number')?cfg.updated:0; setupMenus(cfg.menus||null); } else { setupMenus(null); } })();
        const dataP=fastFetchDataOnce().catch(()=>null);
        await cfgP; render(); loadLocal();
        const data=await dataP; if(data&&data.data) applyState(data.data);
        startRemoteSync(true); startConfigWatch(); ensureAuthUI();
      }else{
        await logout();
      }
    loadSessionMeta(); titleBtn.textContent=(CURRENT_OFFICE_NAME?`${CURRENT_OFFICE_NAME}　在席確認表【開発用】`:'在席確認表【開発用】');
    ensureAuthUI();
    // 初期データ取得
    (async()=>{
      const cfg=await apiPost({ action:'getConfig', token:SESSION_TOKEN, nocache:'1' });
      if(cfg&&!cfg.error){ GROUPS=normalizeConfigClient(cfg); CONFIG_UPDATED=(typeof cfg.updated==='number')?cfg.updated:0; setupMenus(cfg.menus||null); render(); }
      const d=await fastFetchDataOnce(); if(d&&d.data) applyState(d.data);
      startRemoteSync(true); startConfigWatch();
})();
}else{
    loginEl.style.display='flex'; ensureAuthUI();
    loginEl.style.display='flex';
}
});

window.addEventListener('error', e=>{ toast('エラー: '+e.message,false); diagAdd('error: '+e.message); });
</script>
/* 以下、normalizeConfigClient / setupMenus / fastFetchDataOnce / startRemoteSync / startConfigWatch / pushRowDelta などは
   すべて元のコードから変更していません（CSV 以外は無改変）。 */

/* CSV */
function csvProtectFormula(s){ if(s==null) return ''; const v=String(s); return (/^[=\+\-@\t]/.test(v))?"'"+v:v; }
function toCsvRow(arr){ return arr.map(v=>{ const s=csvProtectFormula(v); return /[",\n]/.test(s)?'"'+s.replace(/"/g,'""')+'"':s; }).join(','); }
function makeNormalizedCSV(cfg,data){ const rows=[]; rows.push(toCsvRow(['group_index','group_title','member_order','id','name','ext','status','time','note'])); (cfg.groups||[]).forEach((g,gi)=>{ (g.members||[]).forEach((m,mi)=>{ const id=m.id||''; const rec=(data&&data[id])||{}; rows.push(toCsvRow([gi+1,g.title||'',mi+1,id,m.name||'',m.ext||'',rec.status||(STATUSES[0]?.value||'在席'),rec.time||'',rec.note||''])); }); }); return rows.join('\n'); }

/* 権限UI */
function ensureAuthUI(){ const showAdmin = (SESSION_TOKEN && (isSuper()||isOfficeAdmin())); adminBtn.style.display=showAdmin?'inline-block':'none'; logoutBtn.style.display=SESSION_TOKEN?'inline-block':'none'; }
function showAdminModal(yes){ adminModal.classList.toggle('show', !!yes); }
function applyRoleToAdminPanel(){ adminOfficeRow.style.display = isSuper() ? '' : 'none'; document.querySelectorAll('.admin-box[data-super-only="1"]').forEach(el=>{ el.style.display = isSuper() ? '' : 'none'; }); }
async function populateAdminOffices(selected){ if(isSuper()){ const res=await adminListOffices(); if(!(res&&res.offices)){ toast('拠点一覧の取得に失敗',false); return; } adminOfficeSel.innerHTML=res.offices.map(o=>`<option value="${o.id}">${sanitizeText(o.name)}（${o.id}）</option>`).join(''); if(selected) adminOfficeSel.value=selected; } else { adminOfficeSel.innerHTML=`<option value="${CURRENT_OFFICE_ID}">${sanitizeText(CURRENT_OFFICE_NAME)}（${CURRENT_OFFICE_ID}）</option>`; } }

<datalist id="noteOptions"></datalist>
/* Admin API */
function selectedOfficeId(){ return isSuper()?adminOfficeSel.value:CURRENT_OFFICE_ID; }
async function adminListOffices(){ return await apiPost({ action:'listOffices', token:SESSION_TOKEN }); }
async function adminGetFor(office){ return await apiPost({ action:'getFor', token:SESSION_TOKEN, office, nocache:'1' }); }
async function adminGetConfigFor(office){ return await apiPost({ action:'getConfigFor', token:SESSION_TOKEN, office, nocache:'1' }); }
async function adminSetConfigFor(office,cfgObj,superProof){ const q={ action:'setConfigFor', token:SESSION_TOKEN, office, data:JSON.stringify(cfgObj) }; if(superProof){ q.superHmac=superProof.hmac; q.nonce=superProof.nonce; } return await apiPost(q); }
async function adminSetForChunked(office,dataObjFull,superProof){ const entries=Object.entries(dataObjFull||{}); if(entries.length===0){ const base={ action:'setFor', office, token:SESSION_TOKEN, data:JSON.stringify({updated:Date.now(),data:{},full:true}) }; if(superProof){ base.superHmac=superProof.hmac; base.nonce=superProof.nonce; } return await apiPost(base); } const chunkSize=100; let first=true, ok=true; for(let i=0;i<entries.length;i+=chunkSize){ const chunk=Object.fromEntries(entries.slice(i,i+chunkSize)); const obj={updated:Date.now(),data:chunk,full:first}; const q={ action:'setFor', office, token:SESSION_TOKEN, data:JSON.stringify(obj) }; if(superProof){ q.superHmac=superProof.hmac; q.nonce=superProof.nonce; } const r=await apiPost(q); if(!(r&&r.ok)) ok=false; first=false; } return ok?{ok:true}:{error:'chunk_failed'}; }
async function adminRenameOffice(office,name){ return await apiPost({ action:'renameOffice', office, name, token:SESSION_TOKEN }); }
async function adminAddOffice(id,name,pw,apw){ return await apiPost({ action:'addOffice', id, name, password:pw, adminPassword:apw, token:SESSION_TOKEN }); }
async function adminDeleteOffice(office,superProof){ const q={ action:'deleteOffice', id:office, token:SESSION_TOKEN }; if(superProof){ q.superHmac=superProof.hmac; q.nonce=superProof.nonce; } return await apiPost(q); }
async function adminSetOfficePassword(office,pw,apw,superProof){ const q={ action:'setOfficePassword', id:office, token:SESSION_TOKEN }; if(pw) q.password=pw; if(apw) q.adminPassword=apw; if(superProof){ q.superHmac=superProof.hmac; q.nonce=superProof.nonce; } return await apiPost(q); }

/* CSV */
function csvProtectFormula(s){ if(s==null) return ''; const v=String(s); return (/^[=\+\-@\t]/.test(v))?"'"+v:v; }
function toCsvRow(arr){ return arr.map(v=>{ const s=csvProtectFormula(v); return /[",\n]/.test(s)?'"'+s.replace(/"/g,'""')+'"':s; }).join(','); }
function makeNormalizedCSV(cfg,data){ const rows=[]; rows.push(toCsvRow(['group_index','group_title','member_order','id','name','ext','status','time','note'])); (cfg.groups||[]).forEach((g,gi)=>{ (g.members||[]).forEach((m,mi)=>{ const id=m.id||''; const rec=(data&&data[id])||{}; rows.push(toCsvRow([gi+1,g.title||'',mi+1,id,m.name||'',m.ext||'',rec.status||(STATUSES[0]?.value||'在席'),rec.time||'',rec.note||''])); }); }); return rows.join('\n'); }

/* 権限UI（再掲） */
function ensureAuthUI(){ const showAdmin = (SESSION_TOKEN && (isSuper()||isOfficeAdmin())); adminBtn.style.display=showAdmin?'inline-block':'none'; logoutBtn.style.display=SESSION_TOKEN?'inline-block':'none'; }

</script>
</body>
</html>
