<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>在席確認表【開発用】</title>

<!-- 強めのキャッシュ抑止（HTMLに効く） -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<!-- CSP：Worker への POST を許可 -->
<meta http-equiv="Content-Security-Policy"
      content="default-src 'self';
               script-src 'self';
               connect-src 'self' https://presence-proxy-test.taka-hiyo.workers.dev;
               style-src 'self';
               img-src 'self' data:;
               object-src 'none'">
<link rel="stylesheet" href="styles.css">

</head>
<body>
<header>
    <div class="title-wrap">
      <button id="titleBtn" class="title-btn" aria-haspopup="true" aria-expanded="false" aria-controls="groupMenu">在席確認表【開発用】</button>
      <div id="groupMenu" class="grp-menu" role="menu" aria-labelledby="titleBtn">
        <h4 id="groupMenuTitle">グループにジャンプ</h4>
        <ul id="groupMenuList"></ul>
      </div>
    </div>
    <input id="nameFilter" class="name-filter" type="search" placeholder="氏名検索（入力と同時に絞り込み）" aria-label="氏名検索" />
    <select id="statusFilter" class="status-filter" aria-label="ステータスで絞り込み"></select>
    <button id="adminBtn" class="admin-btn" title="管理">管理</button>
    <button id="logoutBtn" class="logout-btn" title="ログオフ">ログオフ</button>
    <button id="manualBtn" class="manual-btn" title="マニュアル">マニュアル</button>
  </header>

  <!-- 管理モーダル -->
  <div id="adminModal" class="admin-modal" aria-modal="true" role="dialog">
    <div class="admin-card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
        <h3>管理パネル</h3><button id="adminClose">閉じる</button>
      </div>


      <div class="admin-grid">
        <div class="admin-box">
          <h4>CSVエクスポート</h4>
          <div class="admin-row"><button id="btnExport">ダウンロード</button></div>
          <div class="admin-note">形式：グループ番号,グループ名,表示順,id,氏名,内線,業務時間,ステータス,戻り時間,備考（従来ヘッダも可）</div>
        </div>

        <div class="admin-box">
          <h4>CSVインポート</h4>
          <div class="admin-row"><input type="file" id="csvFile" accept=".csv,text/csv" /><button id="btnImport">取り込み</button></div>
        </div>

        <div class="admin-box">
          <h4>拠点名の変更</h4>
          <div class="admin-row"><input id="renameOfficeName" placeholder="新しい拠点名" /><button id="btnRenameOffice">変更</button></div>
        </div>


        <div class="admin-box">
          <h4>拠点パスワードの変更</h4>
          <div class="admin-row">
            <input id="setPw" placeholder="新パスワード（任意）" />
            <input id="setAdminPw" placeholder="新管理者PW（任意）" />
            <button id="btnSetPw">更新</button>
          </div>
        </div>

        <div class="admin-box">
          <h4>メニュー設定（JSON）</h4>
          <div class="admin-row"><textarea id="menusJson" placeholder='{"statuses":[...], "noteOptions":[...], "timeStepMinutes":30}'></textarea></div>
          <div class="admin-row"><button id="btnLoadMenus">現在の設定を読み込み</button><button id="btnSaveMenus">保存</button></div>
        </div>
      </div>
    </div>
  </div>

  <!-- マニュアルモーダル -->
  <div id="manualModal" class="manual-modal" aria-modal="true" role="dialog" aria-labelledby="manualTitle">
    <div class="manual-card" role="document">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
        <h3 id="manualTitle">マニュアル</h3>
        <button id="manualClose" aria-label="閉じる">閉じる</button>
      </div>

      <section id="manualUser" class="manual-section">
        <h4>ユーザーマニュアル</h4>
        
        <h5>ログイン</h5>
        <ul>
          <li>拠点を選択し、パスワードを入力してログインします</li>
          <li>ログイン状態は1時間保持され、自動的に延長されます</li>
        </ul>

        <h5>画面の見方</h5>
        <ul>
          <li><strong>グループパネル</strong>：チーム（グループ）ごとに区切られています</li>
          <li><strong>レイアウト</strong>：画面幅に応じて最大3列まで表示。スマートフォンではカード表示に切り替わります</li>
          <li><strong>グループジャンプ</strong>：タイトルをクリックすると、目的のグループへスムーズに移動できます</li>
        </ul>

        <h5>基本操作</h5>
        <ul>
          <li><strong>業務時間</strong>：「09:00-17:30」のように入力。候補リストから選択も可能</li>
          <li><strong>ステータス</strong>：在席、外出、在宅勤務、出張、研修、健康診断、コアドック、帰宅、休み から選択
            <ul>
              <li>在席（無色）、外出（橙）、在宅勤務（紫）、出張（水色）、研修（緑）、健康診断（桃）、コアドック（薄紫）、帰宅（灰）、休み（赤）</li>
              <li>外出、出張、研修、健康診断、コアドックの場合は戻り時間の入力が<strong>必須</strong></li>
              <li>在席、在宅勤務、帰宅、休みを選択すると、戻り時間と備考が自動クリアされます</li>
            </ul>
          </li>
          <li><strong>戻り時間</strong>：07:00〜22:00の範囲で選択（デフォルト30分刻み）。未入力時は赤枠で表示されます</li>
          <li><strong>備考</strong>：自由入力または候補（直出、直帰、直出・直帰）から選択</li>
        </ul>

        <h5>検索・絞り込み</h5>
        <ul>
          <li><strong>氏名検索</strong>：ヘッダーの検索ボックスに入力すると、リアルタイムで該当者のみ表示</li>
          <li><strong>ステータス絞り込み</strong>：特定のステータスのメンバーのみを表示</li>
          <li>該当者がいないグループは自動的に非表示になります</li>
        </ul>

        <h5>自動更新</h5>
        <ul>
          <li>入力内容は<strong>約2秒後</strong>に自動的にサーバーへ送信されます</li>
          <li>他の端末で入力された内容も約2秒ごとに自動反映されます</li>
          <li>入力中や変換中は、他端末からの更新が一時的に保留されます</li>
          <li>同時編集で競合が発生した場合、サーバーの値が優先されます</li>
        </ul>

        <p style="margin-top:16px;"><strong>詳細マニュアル</strong>：<a href="USER_MANUAL.md" target="_blank">USER_MANUAL.md</a> を参照してください</p>
      </section>

      <section id="manualAdmin" class="manual-section">
        <h4>管理者マニュアル</h4>
        
        <h5>管理パネルの機能</h5>
        <ul>
          <li><strong>CSVエクスポート</strong>：現在の名簿と在席データをCSV形式でダウンロード</li>
          <li><strong>CSVインポート</strong>：名簿の一括登録・更新（形式：グループ番号,グループ名,表示順,id,氏名,内線,業務時間,ステータス,戻り時間,備考）
            <ul>
              <li>業務時間列なしの旧形式CSVにも対応（既存データから業務時間を引き継ぎ）</li>
              <li>インポート前に必ずエクスポートでバックアップを取ってください</li>
            </ul>
          </li>
          <li><strong>拠点名の変更</strong>：ログイン画面や画面タイトルに表示される拠点名を変更</li>
          <li><strong>パスワード変更</strong>：ユーザーパスワードと管理者パスワードを個別に変更可能</li>
          <li><strong>メニュー設定（JSON）</strong>：以下の設定を変更できます
            <ul>
              <li><code>statuses</code>：ステータスの種類、色、戻り時間の要否、自動クリア設定</li>
              <li><code>noteOptions</code>：備考欄の候補リスト</li>
              <li><code>businessHours</code>：業務時間の候補リスト</li>
              <li><code>timeStepMinutes</code>：戻り時間の刻み（分単位、デフォルト30）</li>
            </ul>
          </li>
        </ul>

        <h5>重要な注意事項</h5>
        <ul>
          <li>CSVインポートは名簿全体を置き換えます（部分更新不可）</li>
          <li>パスワードは平文で保存されます（強固なパスワードを使用してください）</li>
          <li>ステータス設定を変更すると、既存データの表示に影響する場合があります</li>
          <li>複数の管理者が同時に操作すると競合する可能性があります</li>
        </ul>

        <p style="margin-top:16px;"><strong>詳細マニュアル</strong>：<a href="ADMIN_MANUAL.md" target="_blank">ADMIN_MANUAL.md</a> を参照してください</p>
      </section>
    </div>
  </div>

  <!-- ログイン -->
  <div id="login" class="login" style="display:none">
    <div class="card">
      <h2>在席確認表【開発用】</h2>
      <p>拠点を選び、パスワードを入力してください</p>
      <select id="officeSel" aria-label="拠点"></select>
      <input type="password" id="pw" placeholder="Password" autocomplete="current-password" />
      <button id="btnLogin">ログイン</button>
      <div id="loginMsg" style="color:#0073bb;margin-top:8px" aria-live="polite"></div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>
  <div class="wrap"><div id="board" class="board" style="display:none"></div></div>
  <div id="diag" class="diag"></div>
  <script src="config.js"></script>
　<script src="js/globals.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/layout.js"></script>
  <script src="js/filters.js"></script>
  <script src="js/board.js"></script>
  <script src="js/offices.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/sync.js"></script>
  <script src="js/admin.js"></script>
  <script src="main.js"></script>

</body>
</html>
