<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>在席確認表【開発用】</title>

<!-- 強めのキャッシュ抑止（HTMLに効く） -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<!-- CSP：Worker への POST を許可 -->
<meta http-equiv="Content-Security-Policy"
      content="default-src 'self';
               script-src 'self' 'unsafe-inline';
               style-src 'self' 'unsafe-inline';
               img-src 'self' data:;
               connect-src 'self' https://script.google.com https://script.googleusercontent.com https://script.google.com/macros/s/AKfycbxpEU6kGE5x8MlMkPy5GHeWGQwNn8b5czQh4JH3oYiHNSyqI5hlHGlTnkXe2CwtatBW/exec;
               base-uri 'self';
               form-action 'self';
               frame-ancestors 'none'">

<style>
  :root{
    --cols: 3;
    --gap: 20px;

    /* 列幅（既定値。管理UIからも変更可能） */
    --w-name:  min(50vw,  50%);
    --w-ext:   min(33vw,  33%);
    --w-status:min(75vw,  75%);
    --w-time:  min(45vw,  45%);
    --w-note:  1fr;

    /* ステータス欄の実効幅（カード時は固定幅を無効化） */
    --status-fixed: initial;
    --status-effective: var(--status-fixed, var(--w-status));

    --gap: 20px;
    --line:#d9d9d9; --head:#f1ece6; --bg:#fafafa;
    --header-height: 56px;
  }

  body{font-family:"Segoe UI","Hiragino Kaku Gothic ProN",Meiryo,sans-serif;background:#fff;margin:16px}

  /* ヘッダ */
  header{
    position: sticky; top: 0; z-index: 1500;
    display:flex; gap:8px; align-items:center; justify-content:center;
    margin-bottom:12px; flex-wrap:wrap; background:#fff; padding:8px 8px 0 8px;
  }
  header .title{ font-weight:800; font-size:18px; margin-right:auto }
  header .row{ display:flex; align-items:center; gap:8px; flex-wrap:wrap }

  select, input[type="text"], input[type="password"], button, textarea{
    font:inherit; padding:.45rem .6rem; border:1px solid var(--line); border-radius:8px; background:#fff
  }
  button{ cursor:pointer }
  button.primary{ background:#111827; color:#fff; border-color:#111827 }
  button.ghost{ background:#fff }
  .muted{ color:#6b7280 }
  .danger{ color:#dc2626 }
  .kbd{ font-family:ui-monospace, "SFMono-Regular", Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background:#f3f4f6; border:1px solid #e5e7eb; border-radius:6px; padding:2px 6px; font-size:12px }

  .pill{ display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border:1px solid var(--line); border-radius:999px; background:#fff; font-size:12px }
  .pill b{ font-weight:800 }

  .flex{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
  .grow{ flex:1 1 auto }
  .right{ margin-left:auto }
  .w-100{ width:100% }

  .dialog{
    position:fixed; inset:0; background:rgba(0,0,0,.5);
    display:none; align-items:center; justify-content:center;
    padding:16px;
  }
  .dialog.show{ display:flex }
  .dialog .box{ width:min(94vw, 840px); background:#fff; border-radius:10px; border:1px solid var(--line); box-shadow:0 8px 40px rgba(0,0,0,.12) }
  .dialog .head{ display:flex; align-items:center; gap:8px; justify-content:space-between; padding:12px 14px; border-bottom:1px solid var(--line); background:#f7f6f3; border-radius:10px 10px 0 0 }
  .dialog .body{ padding:14px; max-height:80vh; overflow:auto }
  .dialog .foot{ padding:12px 14px; border-top:1px solid var(--line); display:flex; align-items:center; gap:8px; justify-content:flex-end; background:#faf9f7; border-radius:0 0 10px 10px }

  .admin-grid{ display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
  .admin-row{ display:flex; gap:8px; align-items:center; }
  .admin-row label{ width:8em; color:#6b7280; font-size:13px }
  .admin-row .note{ font-size:12px; color:#6b7280 }

  .section-title{ font-weight:800; color:#374151; font-size:14px; margin:16px 0 8px 0 }

  textarea{ padding:.35rem .45rem; border:1px solid var(--line); border-radius:6px; min-width:120px; }
  .admin-note{ font-size:12px; color:#6b7280; }

  /* 盤面 */
  .wrap{width:100%; margin:0 auto;}
  .board{
    display:grid; gap:var(--gap);
    /* JS が--colsを入れ損ねても自動で3→2→1に落ちる保険 */
    grid-template-columns: repeat(var(--cols, auto-fit), minmax(min(100%, 760px), 1fr));
  }
  /* 1列モードとカード強制時は画面幅にフィットさせる */
  .board[data-cols="1"],
  .board.force-cards{
    grid-template-columns: 1fr;
  }

  .panel{ border:1px solid var(--line); border-radius:6px; background:var(--bg); padding:8px; overflow:auto;
    scroll-margin-top: calc(var(--header-height) + 12px); }
  .panel .title{ font-weight:700; color:#6B7280; background:#f7f6f3; border:1px solid var(--line); border-radius:4px; padding:6px 8px; margin:0 0 6px 0; min-height:1.8em }

  table{width:100%; border-collapse:separate; border-spacing:0; table-layout:fixed}
  thead th{position:sticky; top:0; background:#f2efe9; font-weight:700}
  th,td{border:1px solid var(--line); padding:6px; font-size:14px}
  th{text-align:left}

  col.col-name{width:var(--w-name)}
  col.col-ext{width:var(--w-ext)}
  col.col-status{width:var(--status-effective)}
  col.col-time{width:var(--w-time)}
  col.col-note{width:var(--w-note)}

  /* カード化（1列時 or 強制） */
  .board[data-cols="1"] table,
  .board.force-cards table{
    display:block; border:none; background:#fff; border-radius:10px; padding:10px; margin:10px 0;
  }
  .board[data-cols="1"] thead,
  .board.force-cards thead{ display:none }
  .board[data-cols="1"] tbody,
  .board.force-cards tbody{ display:flex; flex-direction:column; gap:10px }
  .board[data-cols="1"] tr,
  .board.force-cards tr{
    display:flex; flex-wrap:wrap; align-items:flex-start; gap:10px;
    padding:10px; border:1px solid var(--line); border-radius:10px; background:#fff;
  }
  .board[data-cols="1"] tbody td,
  .board.force-cards tbody td{
    border:none;
    padding:0;
    display:flex;
    align-items:center;
    gap:8px;
    flex:1 1 48%;
    min-width:160px;
    background:transparent;
  }
  .board[data-cols="1"] tbody td::before,
  .board.force-cards tbody td::before{
    content: attr(data-label);
    font-weight:600; color:#6B7280; min-width:5.5em; flex:0 0 auto;
  }
  .board[data-cols="1"] tbody td.name,
  .board.force-cards tbody td.name{
    order:0; flex:1 1 100%; font-weight:800; font-size:15px; line-height:1.2; padding-bottom:2px;
  }
  .board[data-cols="1"] tbody td.name::before,
  .board.force-cards tbody td.name::before{ content:""; display:none }

  .board[data-cols="1"] tbody td.ext{ order:1 }
  .board[data-cols="1"] tbody td.time{ order:2 }
  .board[data-cols="1"] tbody td.status{ order:3 }
  .board[data-cols="1"] tbody td.note{ order:4; flex:1 1 100% }

  .board.force-cards tbody td.ext{ order:1 }
  .board.force-cards tbody td.time{ order:2 }
  .board.force-cards tbody td.status{ order:3 }
  .board.force-cards tbody td.note{ order:4; flex:1 1 100% }

  /* ステータスバッジ */
  .status-badge{
    display:inline-flex; align-items:center; gap:6px;
    border:1px solid var(--line); border-radius:999px; padding:3px 8px; background:#fff; white-space:nowrap;
  }
  .badge-IN{ background:#e7f5ee; border-color:#c7eadb; color:#166534 }
  .badge-OUT{ background:#fff7ed; border-color:#fde2c5; color:#9a3412 }
  .badge-BUSY{ background:#fef2f2; border-color:#fecaca; color:#991b1b }
  .badge-OFF{ background:#eef2ff; border-color:#e0e7ff; color:#3730a3 }

  .note-input{ width:100%; min-width:160px }

  /* ヘルパー */
  .center{ text-align:center }
  .small{ font-size:12px; color:#6b7280 }

  /* 極端に狭い画面のはみ出し防止 */
  @media (max-width: 360px){
    .board[data-cols="1"] tbody td,
    .board.force-cards tbody td{
      min-width: 0;
      flex: 1 1 100%;
    }
  }
</style>
</head>

<body>
<header>
  <div class="title">在席確認表【開発用】</div>

  <div class="row">
    <label class="pill">拠点
      <select id="officeSelect"></select>
    </label>

    <label class="pill">ログイン名
      <input type="text" id="loginId" placeholder="user/admin">
    </label>

    <label class="pill">パスワード
      <input type="password" id="loginPw" placeholder="••••••••">
    </label>

    <button id="btnLogin" class="primary">ログイン</button>
    <button id="btnLogout" class="ghost">ログアウト</button>

    <span id="loginState" class="pill muted">未ログイン</span>
  </div>

  <div class="row right">
    <button id="btnForceCards" class="ghost">カード表示を強制</button>
    <button id="btnReload" class="ghost">最新に更新</button>
  </div>
</header>

<main class="wrap">
  <div id="board" class="board" data-cols="3" aria-live="polite"></div>
</main>

<!-- 管理ダイアログ（拠点・列幅など） -->
<div id="dlgAdmin" class="dialog" role="dialog" aria-modal="true" aria-labelledby="adminTitle">
  <div class="box">
    <div class="head">
      <div id="adminTitle" class="section-title">管理設定</div>
      <button id="btnCloseAdmin">×</button>
    </div>
    <div class="body">
      <div class="admin-grid">
        <div class="admin-row">
          <label>氏名の幅</label>
          <input type="text" id="wName" placeholder="例: 50%">
        </div>
        <div class="admin-row">
          <label>内線の幅</label>
          <input type="text" id="wExt" placeholder="例: 33%">
        </div>
        <div class="admin-row">
          <label>ステータスの幅</label>
          <input type="text" id="wStatus" placeholder="例: 75%">
        </div>
        <div class="admin-row">
          <label>戻り時間の幅</label>
          <input type="text" id="wTime" placeholder="例: 45%">
        </div>
        <div class="admin-row">
          <label>備考の幅</label>
          <input type="text" id="wNote" placeholder="例: 1fr">
        </div>
      </div>
      <p class="admin-note">値は <b>% / px / fr / minmax()</b> など CSS 幅指定が使えます。</p>
    </div>
    <div class="foot">
      <button id="btnAdminCancel" class="ghost">キャンセル</button>
      <button id="btnAdminSave" class="primary">保存</button>
    </div>
  </div>
</div>

<script>
/* ====== 設定 ====== */
const ENDPOINT = "https://script.google.com/macros/s/AKfycbxpEU6kGE5x8MlMkPy5GHeWGQwNn8b5czQh4JH3oYiHNSyqI5hlHGlTnkXe2CwtatBW/exec";

/* ====== DOM 取得 ====== */
const board = document.getElementById('board');
const officeSelect = document.getElementById('officeSelect');
const loginId = document.getElementById('loginId');
const loginPw = document.getElementById('loginPw');
const btnLogin = document.getElementById('btnLogin');
const btnLogout = document.getElementById('btnLogout');
const loginState = document.getElementById('loginState');
const btnReload = document.getElementById('btnReload');
const btnForceCards = document.getElementById('btnForceCards');

const dlgAdmin = document.getElementById('dlgAdmin');
const btnCloseAdmin = document.getElementById('btnCloseAdmin');
const btnAdminCancel = document.getElementById('btnAdminCancel');
const btnAdminSave = document.getElementById('btnAdminSave');

const iW = (id)=>document.getElementById(id).value.trim();

/* ====== レイアウト（列数自動） ====== */
let ro = null; // ResizeObserver

const PANEL_MIN_PX = 760;  // 1パネルの最小幅（CSSと連動）
const GAP_PX = 20;         // グリッドのギャップ（CSSと連動）
const MAX_COLS = 3;

function getContainerWidth(){
  const elc = board.parentElement || document.body;
  const r = elc.getBoundingClientRect();
  return Math.max(0, Math.round(r.width));
}

function calcCols(w){
  // gapは (cols-1)*GAP_PX
  for(let c=MAX_COLS; c>=1; c--){
    const need = c * PANEL_MIN_PX + (c-1) * GAP_PX;
    if(w >= need) return c;
  }
  return 1;
}

function updateCols(){
  const w = getContainerWidth();
  let n = calcCols(w);
  // data-cols 属性に反映（CSSで1列時は強制1frに）
  board.dataset.cols = String(n);
  board.classList.toggle('force-cards', n === 1);
}

function startGridObserver(){
  if(ro) ro.disconnect();
  ro = new ResizeObserver(updateCols);
  ro.observe(board.parentElement || document.body);
  window.addEventListener('resize', updateCols, {passive:true});
  updateCols();
}

/* ====== 名簿正規化 ====== */
function makeLocalId(s){
  const seed = (s||"").normalize('NFKC').replace(/\s+/g,' ').trim();
  let h = 0;
  for(let i=0;i<seed.length;i++){ h=(h*31+seed.charCodeAt(i))>>>0; }
  return "P"+(h.toString(16)+"00000000").slice(0,8);
}
function normalizeConfigClient(cfg){
  const groups = Array.isArray(cfg?.groups) ? cfg.groups : [];
  return groups.map((g,idx)=>({
    title: (typeof g.title==='string'? g.title : `グループ${idx+1}`),
    members: (Array.isArray(g.members)? g.members : []).map(m=>{
      let name = (m?.name??"").trim();
      let ext  = (m?.ext ??"").trim();
      let id   = (m?.id  ??"").trim();
      if(!name) name = `未設定${idx+1}-${Math.random().toString(16).slice(2,6)}`;
      if(!id) id = makeLocalId(name+ext);
      return {name,ext,id};
    })
  }));
}

/* ====== UI構築 ====== */
function el(tag, attrs={}, children=[]){
  const x = document.createElement(tag);
  for(const [k,v] of Object.entries(attrs)){
    if(k==='class') x.className = v;
    else if(k==='dataset') Object.assign(x.dataset, v);
    else if(k.startsWith('on') && typeof v==='function') x.addEventListener(k.slice(2), v);
    else if(v!=null) x.setAttribute(k, String(v));
  }
  if(!Array.isArray(children)) children=[children];
  for(const ch of children){
    if(ch==null) continue;
    if(typeof ch==='string') x.appendChild(document.createTextNode(ch));
    else x.appendChild(ch);
  }
  return x;
}

function statusBadge(s){
  const map = {IN:'出社', OUT:'外出', BUSY:'取込', OFF:'休み'};
  const label = map[s] ?? s ?? '';
  const cls = "status-badge " + (s?("badge-"+s):"");
  return el('span', {class:cls}, label);
}

function personRow(p){
  // テーブル行（カード時はCSSで再配置）
  const tr = el('tr', {}, [
    el('td', {class:'name', 'data-label':'氏名'}, p.name),
    el('td', {class:'ext',  'data-label':'内線'}, p.ext||''),
    el('td', {class:'status', 'data-label':'ステータス'}, statusBadge(p.status||'IN')),
    el('td', {class:'time', 'data-label':'戻り時間'}, p.time||''),
    el('td', {class:'note', 'data-label':'備考'}, p.note? String(p.note): '')
  ]);
  return tr;
}

function groupPanel(g, idx){
  const table = el('table', {}, [
    el('colgroup', {}, [
      el('col', {class:'col-name'}),
      el('col', {class:'col-ext'}),
      el('col', {class:'col-status'}),
      el('col', {class:'col-time'}),
      el('col', {class:'col-note'})
    ]),
    el('thead', {}, [
      el('tr', {}, [
        el('th', {}, '氏名'),
        el('th', {}, '内線'),
        el('th', {}, 'ステータス'),
        el('th', {}, '戻り'),
        el('th', {}, '備考'),
      ])
    ]),
    el('tbody', {}, (g.members||[]).map(personRow))
  ]);

  const titleText = (g.title||'').trim() || `グループ${idx+1}`;
  return el('section', {class:'panel', 'aria-label':titleText}, [
    el('div', {class:'title'}, titleText),
    table
  ]);
}

function drawBoard(cfg){
  board.innerHTML='';
  const groups = normalizeConfigClient(cfg);
  const frags = document.createDocumentFragment();
  groups.forEach((g,i)=> frags.appendChild(groupPanel(g,i)));
  board.appendChild(frags);
  updateCols();
}

/* ====== データ取得 ====== */
async function post(action, payload={}){
  const body = new URLSearchParams({action, ...payload});
  const res = await fetch(ENDPOINT, {
    method:'POST',
    mode:'cors',
    headers:{'Content-Type':'application/x-www-form-urlencoded'},
    body
  });
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  // GAS 側が text/plain / text/html を返す場合もある
  const ct = res.headers.get('content-type')||'';
  if(ct.includes('application/json')) return res.json();
  const text = await res.text();
  try{ return JSON.parse(text); }catch(_){ return {raw:text}; }
}

async function listOffices(){
  const r = await post('publicListOffices');
  const items = r?.offices || r?.data || [];
  officeSelect.innerHTML='';
  for(const o of items){
    const opt = document.createElement('option');
    opt.value = o.key || o.id || o.name;
    opt.textContent = o.name || o.title || opt.value;
    officeSelect.appendChild(opt);
  }
}

async function loadBoard(){
  const office = officeSelect.value || '';
  const r = await post('publicGetConfig', {office});
  const cfg = r?.config || r?.data || r;
  drawBoard(cfg);
}

/* ====== 認証（ダミーUI：稼働用はGAS側で検証） ====== */
async function doLogin(){
  const office = officeSelect.value || '';
  const id = loginId.value.trim();
  const pw = loginPw.value.trim();
  const r = await post('login', {office, id, pw}).catch(()=>({ok:false}));
  const ok = !!r?.ok;
  loginState.textContent = ok? `ログイン中: ${id}` : '未ログイン';
}
function doLogout(){
  loginState.textContent = '未ログイン';
}

/* ====== 管理UI（列幅など CSS 変数に反映） ====== */
function openAdmin(){
  document.getElementById('wName').value = getComputedStyle(document.documentElement).getPropertyValue('--w-name').trim();
  document.getElementById('wExt').value = getComputedStyle(document.documentElement).getPropertyValue('--w-ext').trim();
  document.getElementById('wStatus').value = getComputedStyle(document.documentElement).getPropertyValue('--w-status').trim();
  document.getElementById('wTime').value = getComputedStyle(document.documentElement).getPropertyValue('--w-time').trim();
  document.getElementById('wNote').value = getComputedStyle(document.documentElement).getPropertyValue('--w-note').trim();
  dlgAdmin.classList.add('show');
}
function closeAdmin(){ dlgAdmin.classList.remove('show'); }
function saveAdmin(){
  const r = document.documentElement.style;
  if(iW('wName'))   r.setProperty('--w-name',   iW('wName'));
  if(iW('wExt'))    r.setProperty('--w-ext',    iW('wExt'));
  if(iW('wStatus')) r.setProperty('--w-status', iW('wStatus'));
  if(iW('wTime'))   r.setProperty('--w-time',   iW('wTime'));
  if(iW('wNote'))   r.setProperty('--w-note',   iW('wNote'));
  closeAdmin();
  updateCols();
}

/* ====== イベント ====== */
btnLogin.addEventListener('click', doLogin);
btnLogout.addEventListener('click', doLogout);
btnReload.addEventListener('click', loadBoard);

btnForceCards.addEventListener('click', ()=>{
  // CSS 側の 1列時と同じスタイルを強制
  board.classList.toggle('force-cards');
  updateCols();
});

// 管理ダイアログ（簡易：タイトルクリックで開く例）
document.querySelector('header .title').addEventListener('click', openAdmin);
btnCloseAdmin.addEventListener('click', closeAdmin);
btnAdminCancel.addEventListener('click', closeAdmin);
btnAdminSave.addEventListener('click', saveAdmin);

/* ====== 起動 ====== */
(async function init(){
  await listOffices().catch(console.warn);
  await loadBoard().catch(console.warn);
  startGridObserver();
})();
</script>
</body>
</html>
